<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Doctor - Your Tech Solution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
            color: #334155; /* Tailwind slate-700 */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* Tailwind slate-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* Tailwind slate-400 */
        }
        .main-content {
            min-height: calc(100vh - 80px - 80px); /* Adjust for header and footer height */
        }
        /* Styles for the modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            max-width: 90%;
            width: 450px; /* Slightly wider for registration */
            position: relative; /* For close button positioning */
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .login-history-panel {
            background-color: #e0f2fe; /* Light blue background */
            border: 1px solid #90cdf4; /* Blue border */
            border-radius: 0.75rem; /* Rounded corners */
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.875rem; /* text-sm */
            color: #2b6cb0; /* Dark blue text */
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .login-history-panel ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .login-history-panel li {
            padding: 0.25rem 0;
            border-bottom: 1px dotted #bfdbfe; /* Lighter blue dotted border */
        }
        .login-history-panel li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-lg">
        <div class="container mx-auto flex flex-wrap justify-between items-center px-4 gap-y-4">
            <h1 class="text-3xl font-bold rounded-lg p-2 hover:bg-blue-700 transition duration-300">
                <a href="#" id="homeLink" class="text-white no-underline">Mobile Doctor</a>
            </h1>
            <nav class="flex items-center space-x-4 sm:space-x-6">
                <div class="relative">
                    <label for="currencySelect" class="sr-only">Select Currency</label>
                    <select id="currencySelect" class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-300 appearance-none pr-8 cursor-pointer">
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR (€)</option>
                        <option value="GBP">GBP (£)</option>
                        <option value="INR">INR (₹)</option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-white">
                        <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                    </div>
                </div>

                <button id="viewCartBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 relative">
                    Cart (<span id="cartItemCount">0</span>)
                </button>
                <button id="toggleAdminPanelBtn" class="bg-indigo-500 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300 hidden">
                    Admin Panel
                </button>
                <button id="loginLogoutBtn" class="bg-purple-500 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300" disabled>
                    Login/Logout
                </button>
            </nav>
        </div>
        <div class="container mx-auto mt-4 px-4 flex flex-col sm:flex-row gap-4 items-center">
            <div class="relative flex-grow w-full sm:w-auto">
                <input type="text" id="productSearchInput" placeholder="Search products..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 text-gray-800 bg-white shadow-sm">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
            <div class="relative w-full sm:w-auto">
                <select id="categoryFilterSelect" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-300 appearance-none pr-8 cursor-pointer border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="all">Please Select Category</option>
                    </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
            <div class="relative w-full sm:w-auto">
                <select id="brandFilterSelect" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-300 appearance-none pr-8 cursor-pointer border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="all">Please Select Brand</option>
                    </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
            <div class="relative w-full sm:w-auto">
                <select id="partTypeFilterSelect" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-sm transition duration-300 appearance-none pr-8 cursor-pointer border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="all">Please Select Part Type</option>
                    </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                    <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-6 mt-4 main-content">
        <div id="loginHistoryPanel" class="hidden login-history-panel">
            <h3 class="text-lg font-semibold mb-2">Previous Login Timestamps:</h3>
            <ul id="loginTimestampsList">
                </ul>
        </div>

        <section id="storeView" class="mb-12">
            <h2 class="text-4xl font-extrabold text-center mb-10 text-gray-800 tracking-tight">Discover Our Products</h2>
            <div id="productGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8">
                </div>
            <p id="noFilteredProductsMessage" class="col-span-full text-center text-gray-500 text-lg hidden mt-8">No products match your search/filter criteria.</p>
        </section>

        <section id="cartView" class="hidden mb-12 bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-4xl font-extrabold text-center mb-8 text-gray-800">Your Shopping Cart</h2>
            <div id="cartItems" class="space-y-6">
                </div>
            <div id="cartSummary" class="mt-10 pt-6 border-t-2 border-gray-100 flex justify-between items-center text-2xl font-bold text-gray-900">
                <span>Total:</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <div class="mt-10 flex justify-end">
                <button id="checkoutBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform transition duration-300 hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </section>

        <section id="paymentView" class="hidden mb-12 bg-white p-8 rounded-xl shadow-lg border border-gray-200 text-center">
            <h2 class="text-4xl font-extrabold mb-8 text-gray-800">Order Placed Successfully!</h2>
            <p class="text-xl text-gray-700 mb-6">Thank you for your purchase. Please complete your payment to confirm your order.</p>
            <div class="bg-blue-50 border border-blue-200 p-6 rounded-lg inline-block shadow-md">
                <p class="text-lg font-semibold text-blue-800 mb-2">Payment Details:</p>
                <p class="text-3xl font-bold text-blue-600 mb-4">Pay to: +91 7382048432</p>
                <p class="text-lg text-gray-700">You can pay via any UPI app, bank transfer, or other digital payment methods.</p>
                <p class="text-sm text-gray-500 mt-4">Your order will be processed upon successful payment verification.</p>
            </div>
            <button id="returnToStoreBtn" class="mt-8 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow-xl transform transition duration-300 hover:scale-105">
                Return to Store
            </button>
        </section>


        <section id="adminPanel" class="hidden bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <h2 class="text-4xl font-extrabold text-center mb-8 text-gray-800">Admin Panel: Manage Products & Categories</h2>

            <div class="mb-10 p-6 bg-blue-50 rounded-lg border border-blue-200 shadow-md">
                <h3 id="formTitle" class="text-2xl font-semibold mb-6 text-blue-700">Add New Product</h3>
                <form id="productForm" class="space-y-4">
                    <div>
                        <label for="productName" class="block text-gray-700 font-medium mb-1">Product Name</label>
                        <input type="text" id="productName" name="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="productDescription" class="block text-gray-700 font-medium mb-1">Description</label>
                        <textarea id="productDescription" name="description" rows="4" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200"></textarea>
                    </div>
                    <div>
                        <label for="productPrice" class="block text-gray-700 font-medium mb-1">Price (in USD)</label>
                        <input type="number" id="productPrice" name="price" step="0.01" min="0.01" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="productImageUrl" class="block text-gray-700 font-medium mb-1">Image URL</label>
                        <input type="url" id="productImageUrl" name="imageUrl" placeholder="https://placehold.co/400x300/F0F0F0/000000?text=Product" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                    </div>
                    <div>
                        <label for="productCategory" class="block text-gray-700 font-medium mb-1">Category</label>
                        <select id="productCategory" name="category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="">Select a Category</option>
                            </select>
                    </div>
                    <div>
                        <label for="productBrand" class="block text-gray-700 font-medium mb-1">Brand</label>
                        <select id="productBrand" name="brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="">Select a Brand</option>
                            </select>
                    </div>
                    <div>
                        <label for="productPartType" class="block text-gray-700 font-medium mb-1">Part Type</label>
                        <select id="productPartType" name="partType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                            <option value="">Select a Part Type</option>
                            </select>
                    </div>
                    <input type="hidden" id="productId" name="id">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <span id="submitBtnText">Add Product</span>
                    </button>
                    <button type="button" id="cancelEditBtn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ml-4">
                        Cancel Edit
                    </button>
                </form>
            </div>

            <div class="mb-10 p-6 bg-green-50 rounded-lg border border-green-200 shadow-md">
                <h3 class="text-2xl font-semibold mb-6 text-green-700">Manage Categories</h3>
                <form id="categoryForm" class="space-y-4">
                    <div>
                        <label for="categoryName" class="block text-gray-700 font-medium mb-1">Category Name</label>
                        <input type="text" id="categoryName" name="name" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 transition duration-200">
                    </div>
                    <input type="hidden" id="categoryId" name="id">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300">
                        <span id="submitCategoryBtnText">Add Category</span>
                    </button>
                    <button type="button" id="cancelCategoryEditBtn" class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ml-4">
                        Cancel
                    </button>
                </form>
                <h4 class="text-xl font-semibold mt-8 mb-4 text-green-700">Current Categories</h4>
                <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                    <table class="min-w-full bg-white divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminCategoryList" class="divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
                <p id="noCategoriesMessage" class="text-center text-gray-500 mt-4 hidden">No categories added yet. Add one above!</p>
            </div>


            <h3 class="text-2xl font-semibold mb-4 text-gray-800">Current Products</h3>
            <div class="overflow-x-auto rounded-lg shadow-md border border-gray-200">
                <table class="min-w-full bg-white divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (USD)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Part Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminProductList" class="divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <p id="noProductsMessage" class="text-center text-gray-500 mt-4 hidden">No products added yet. Add one above!</p>
        </section>
    </main>

    <footer class="bg-gray-800 text-white p-6 mt-10 shadow-inner">
        <div class="container mx-auto text-center text-sm">
            &copy; 2025 Mobile Doctor. All rights reserved. | <a href="#" class="hover:underline text-blue-300">Privacy Policy</a> | <a href="#" class="hover:underline text-blue-300">Terms of Service</a>
        </div>
    </footer>

    <div id="loginModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center text-gray-800">Login to Mobile Doctor</h3>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="usernameLogin" class="block text-gray-700 text-sm font-bold mb-2">Username (Email)</label>
                    <input type="email" id="usernameLogin" name="username" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@example.com">
                </div>
                <div>
                    <label for="passwordLogin" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="passwordLogin" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Your password">
                </div>
                <div class="flex items-center justify-between mt-6">
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">
                        Login
                    </button>
                    <button type="button" id="showRegisterBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300" disabled>
                        Register
                    </button>
                </div>
                <div class="mt-4">
                    <button type="button" id="googleSignInBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300 flex items-center justify-center">
                        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.24 10.26c-.2-.6-.35-1.25-.35-1.91 0-1.54.54-2.83 1.46-3.77.94-.95 2.14-1.42 3.52-1.42 1.34 0 2.5.42 3.4 1.25s1.42 1.95 1.42 3.32c0 1.2-.34 2.22-.98 3.06-.65.84-1.57 1.53-2.76 2.05-.33.14-.66.27-1 .39l-.48.17c-1.35.48-2.6.72-3.86.72-1.27 0-2.48-.25-3.62-.75s-2.07-1.2-2.73-1.92c-.67-.72-1-1.58-1-2.58 0-.96.34-1.78 1-2.47s1.6-.98 2.6-.98c1.37 0 2.37.52 3.03 1.55zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1.8-12.24l.58-1.53c.6.22 1.2.45 1.77.69.57.24 1.1.48 1.6.73l.48.24-.3.9c-.3-.12-.6-.24-.9-.37-.3-.13-.6-.26-.9-.39z" fill="currentColor"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                        Sign in with Google
                    </button>
                </div>
                <p class="text-sm text-center text-gray-500 mt-6">
                    New user? Register for an account. Existing admin users should log in with their registered email/password.
                    For a local admin test, use email 'kundan' and password 'kundan'.
                </p>
            </form>
            <button type="button" id="closeLoginModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
        </div>
    </div>

    <div id="registerModal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-6 text-center text-gray-800">Register New User</h3>
            <form id="registerForm" class="space-y-4">
                <div>
                    <label for="usernameRegister" class="block text-gray-700 text-sm font-bold mb-2">Username</label>
                    <input type="text" id="usernameRegister" name="username" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Choose a username">
                </div>
                <div>
                    <label for="emailRegister" class="block text-gray-700 text-sm font-bold mb-2">Email ID</label>
                    <input type="email" id="emailRegister" name="email" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="your@example.com">
                </div>
                <div>
                    <label for="passwordRegister" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                    <input type="password" id="passwordRegister" name="password" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Choose a password">
                </div>
                <div>
                    <label for="confirmPasswordRegister" class="block text-gray-700 text-sm font-bold mb-2">Confirm Password</label>
                    <input type="password" id="confirmPasswordRegister" name="confirmPassword" required class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Re-enter password">
                </div>
                <div class="flex items-center justify-between mt-6">
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">
                        Register
                    </button>
                    <button type="button" id="cancelRegisterBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-lg focus:outline-none focus:shadow-outline transition duration-300">
                        Cancel
                    </button>
                </div>
            </form>
            <button type="button" id="closeRegisterModal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-3xl font-bold">&times;</button>
        </div>
    </div>

    <div id="authStatusMessage" class="fixed bottom-4 right-4 p-3 bg-gray-700 text-white text-sm rounded-lg shadow-lg z-[1002]">
        Initializing authentication...
    </div>


    



<script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBFKQa1_X2K3fSp1o0Co5uy9neWK9GGceQ",
    authDomain: "mobile-doctor-app.firebaseapp.com",
    projectId: "mobile-doctor-app",
    storageBucket: "mobile-doctor-app.firebasestorage.app",
    messagingSenderId: "831443700901",
    appId: "1:831443700901:web:5848c1e848e4503b28514c"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>












        // Determine which Firebase config to use: Canvas-provided or custom
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : customFirebaseConfig;

        // Determine which appId to use: Canvas-provided or from custom config
        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


        let app;
        let db;
        let auth;
        let userId; // The Firebase user ID (uid) from Firebase Auth
        let isAuthReady = false; // Flag to indicate if Firebase auth state is resolved

        // --- Utility Functions ---

        // Helper to generate a unique ID for products and categories
        const generateUniqueId = () => '_' + Math.random().toString(36).substr(2, 9);

        // --- Initial Product Data (for demonstration if Firestore is empty) ---
        const initialProductsData = [
            {
                id: generateUniqueId(),
                name: "Smartphone Screen Repair Kit",
                description: "DIY kit for fixing cracked smartphone screens. Includes tools and adhesive.",
                price: 29.99,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Screen+Repair+Kit",
                category: "Tools",
                brand: "Relife",
                partType: "Tools",
                createdAt: Timestamp.now()
            },
            {
                id: generateUniqueId(),
                name: "Laptop Battery Replacement",
                description: "High-capacity replacement battery for popular laptop models. Extend your device's life.",
                price: 79.99,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Laptop+Battery",
                category: "Laptop",
                brand: "Dell",
                partType: "Laptop Battery",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 5) // 5 days ago
            },
            {
                id: generateUniqueId(),
                name: "Wireless Earbuds Cleaning Kit",
                description: "Keep your earbuds hygienic and sounding great with this specialized cleaning kit.",
                price: 14.50,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Earbud+Cleaner",
                category: "Tools",
                brand: "Unknown",
                partType: "Tools",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 2) // 2 days ago
            },
            {
                id: generateUniqueId(),
                name: "Gaming Console HDMI Port Fix",
                description: "Professional repair service for damaged HDMI ports on gaming consoles. Fast turnaround.",
                price: 120.00,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=HDMI+Repair",
                category: "Tools", // Or "Repair Services" if you want to add that category
                brand: "Playstation",
                partType: "Tools",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 10) // 10 days ago
            },
            {
                id: generateUniqueId(),
                name: "Tablet Digitizer Replacement",
                description: "Restore touch functionality to your tablet with a new digitizer. Expert installation recommended.",
                price: 55.00,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Tablet+Digitizer",
                category: "Tablet",
                brand: "Samsung",
                partType: "Tablet Touch",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 7) // 7 days ago
            },
            {
                id: generateUniqueId(),
                name: "Data Recovery Service (USB Drive)",
                description: "Attempt to recover lost data from damaged or corrupted USB flash drives. Success rates vary.",
                price: 99.00,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Data+Recovery",
                category: "Tools",
                brand: "Western Digital",
                partType: "Tools",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 1) // 1 day ago
            },
            {
                id: generateUniqueId(),
                name: "Smartwatch Display Assembly",
                description: "Complete display assembly for various smartwatch brands. Bring your wearable back to life.",
                price: 45.00,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Smartwatch+Display",
                category: "Smart Watch",
                brand: "Apple",
                partType: "Watch Folder",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 3) // 3 days ago
            },
            {
                id: generateUniqueId(),
                name: "Headphone Jack Repair Toolset",
                description: "Specialized tools for repairing loose or faulty headphone jacks on audio devices.",
                price: 22.00,
                imageUrl: "https://placehold.co/400x300/F0F0F0/000000?text=Headphone+Tools",
                category: "Tools",
                brand: "ESD Tools",
                partType: "Tools",
                createdAt: Timestamp.fromMillis(Date.now() - 86400000 * 6) // 6 days ago
            }
        ];

        // Initial Categories Data (for demonstration if Firestore is empty)
        // User provided category filters, mapping to broad categories
        const initialCategoriesData = [
            { id: generateUniqueId(), name: "Laptop" },
            { id: generateUniqueId(), name: "Mobile" },
            { id: generateUniqueId(), name: "Smart Watch" },
            { id: generateUniqueId(), name: "Tablet" },
            { id: generateUniqueId(), name: "Tools" }
        ];

        // Hardcoded Brand Options (from user request)
        const allBrands = [
            "Acer", "Apple", "Asus", "BlackBerry", "Canon", "Coolpad", "Crucial",
            "Datamini", "Dell", "Elevn", "Epson", "ESD Tools", "EVM", "Fujifilm",
            "Gionee", "Google", "Honor", "Hp", "HTC", "Huawei", "Iball", "Infinix",
            "Iqoo", "Itel", "Lava", "Lenovo", "LG", "Micromax", "Microsoft", "Motorola",
            "MSI", "Nikon", "Nokia", "Nothing", "Olympus", "Oneplus", "Oppo", "Panasonic",
            "Philips", "Playstation", "Poco", "Realme", "Relife", "Samsung", "Sony",
            "TCL", "Tecno", "Toshiba", "Tvs", "Unknown", "Vivo", "Western Digital", "Xbox", "Xiaomi"
        ];

        // Hardcoded Part Type Options (from user request)
        const allPartTypes = [
            "All", "Back Camera", "Base LED", "Charging Flex Board", "Combo Offer",
            "Fingerprint", "Front Camera", "Housing", "Housing with Spare Parts",
            "IO Board", "Laptop Adapter", "Laptop Battery", "Laptop Body",
            "Laptop Cable", "Laptop Fans", "Laptop Hinges", "Laptop Keyboard",
            "Laptop Mic", "Laptop Screen", "Laptop Speaker", "LCD Flex", "Main Flex",
            "Middle Frame", "Mobile Back Panel", "Mobile Battery", "Mobile Camera Lens",
            "Mobile Folder", "On Off Flex", "RAM", "Ringer Box", "SIM Tray", "SSD",
            "Tablet Battery", "Tablet Flex", "Tablet Folder", "Tablet Glass",
            "Tablet LCD", "Tablet Touch", "Tools", "Volume Flex", "Watch Folder"
        ];


        // --- DOM Elements ---
        const homeLink = document.getElementById('homeLink');
        const viewCartBtn = document.getElementById('viewCartBtn');
        const cartItemCount = document.getElementById('cartItemCount');
        const toggleAdminPanelBtn = document.getElementById('toggleAdminPanelBtn');
        const loginLogoutBtn = document.getElementById('loginLogoutBtn');
        const currencySelect = document.getElementById('currencySelect');
        const authStatusMessage = document.getElementById('authStatusMessage');
        const loginHistoryPanel = document.getElementById('loginHistoryPanel');
        const loginTimestampsList = document.getElementById('loginTimestampsList');


        const productSearchInput = document.getElementById('productSearchInput');
        const categoryFilterSelect = document.getElementById('categoryFilterSelect');
        const brandFilterSelect = document.getElementById('brandFilterSelect'); // New
        const partTypeFilterSelect = document.getElementById('partTypeFilterSelect'); // New
        const noFilteredProductsMessage = document.getElementById('noFilteredProductsMessage');

        const storeView = document.getElementById('storeView');
        const productGrid = document.getElementById('productGrid');

        const cartView = document.getElementById('cartView');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTotalSpan = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');

        const paymentView = document.getElementById('paymentView');
        const returnToStoreBtn = document.getElementById('returnToStoreBtn');

        const adminPanel = document.getElementById('adminPanel');
        const productForm = document.getElementById('productForm');
        const formTitle = document.getElementById('formTitle');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productDescriptionInput = document.getElementById('productDescription');
        const productPriceInput = document.getElementById('productPrice');
        const productImageUrlInput = document.getElementById('productImageUrl');
        const productCategorySelect = document.getElementById('productCategory');
        const productBrandSelect = document.getElementById('productBrand'); // New
        const productPartTypeSelect = document.getElementById('productPartType'); // New
        const submitBtnText = document.getElementById('submitBtnText');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const adminProductList = document.getElementById('adminProductList');
        const noProductsMessage = document.getElementById('noProductsMessage');

        // New Category Management Elements
        const categoryForm = document.getElementById('categoryForm');
        const categoryIdInput = document.getElementById('categoryId');
        const categoryNameInput = document.getElementById('categoryName');
        const submitCategoryBtnText = document.getElementById('submitCategoryBtnText');
        const cancelCategoryEditBtn = document.getElementById('cancelCategoryEditBtn');
        const adminCategoryList = document.getElementById('adminCategoryList');
        const noCategoriesMessage = document.getElementById('noCategoriesMessage');


        const loginModal = document.getElementById('loginModal');
        const loginForm = document.getElementById('loginForm');
        const usernameLoginInput = document.getElementById('usernameLogin');
        const passwordLoginInput = document.getElementById('passwordLogin');
        const showRegisterBtn = document.getElementById('showRegisterBtn');
        const closeLoginModalBtn = document.getElementById('closeLoginModal');
        const googleSignInBtn = document.getElementById('googleSignInBtn'); // New Google Sign-In button

        const registerModal = document.getElementById('registerModal');
        const registerForm = document.getElementById('registerForm');
        const usernameRegisterInput = document.getElementById('usernameRegister');
        const emailRegisterInput = document.getElementById('emailRegister');
        const passwordRegisterInput = document.getElementById('passwordRegister');
        const confirmPasswordRegisterInput = document.getElementById('confirmPasswordRegister');
        const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
        const closeRegisterModalBtn = document.getElementById('closeRegisterModal');

        // --- Application State ---
        let products = []; // Array to store all products from Firestore
        let categories = []; // Array to store all categories from Firestore
        let cart = [];      // Array to store items in the cart (local storage)
        let currentView = 'store'; // 'store', 'cart', 'admin', or 'payment'
        let currentSearchQuery = '';
        let currentCategoryFilter = 'all';
        let currentBrandFilter = 'all'; // New
        let currentPartTypeFilter = 'all'; // New

        // --- Authentication State ---
        let appUser = null;
        let currentCurrency = 'USD';

        // --- Local Storage Keys ---
        const CART_STORAGE_KEY = 'ecommerce_cart';
        const CURRENCY_STORAGE_KEY = 'ecommerce_currency';

        // --- Currency Data ---
        const currencySymbols = {
            'USD': '$',
            'EUR': '€',
            'GBP': '£',
            'INR': '₹',
        };
        const exchangeRates = {
            'USD': { 'USD': 1, 'EUR': 0.92, 'GBP': 0.79, 'INR': 83.00 },
            'EUR': { 'USD': 1.09, 'EUR': 1, 'GBP': 0.86, 'INR': 90.50 },
            'GBP': { 'USD': 1.27, 'EUR': 1.16, 'GBP': 1, 'INR': 105.00 },
            'INR': { 'USD': 0.012, 'EUR': 0.011, 'GBP': 0.0095, 'INR': 1 },
        };

        // --- Data Persistence (Local Storage for Cart/Currency only) ---
        const loadCart = () => {
            const storedCart = localStorage.getItem(CART_STORAGE_KEY);
            if (storedCart) {
                cart = JSON.parse(storedCart);
            }
        };

        const saveCart = () => {
            localStorage.setItem(CART_STORAGE_KEY, JSON.stringify(cart));
            updateCartCount();
        };

        const loadCurrency = () => {
            const storedCurrency = localStorage.getItem(CURRENCY_STORAGE_KEY);
            if (storedCurrency) {
                currentCurrency = storedCurrency;
            }
            currencySelect.value = currentCurrency;
        };

        const saveCurrency = () => {
            localStorage.setItem(CURRENCY_STORAGE_KEY, currentCurrency);
        };

        // --- Currency Formatting ---
        const formatPriceForDisplay = (amount) => {
            const rate = exchangeRates['USD'][currentCurrency];
            if (!rate) {
                console.warn(`No exchange rate found from USD to ${currentCurrency}. Displaying USD.`);
                return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
            }
            const convertedAmount = amount * rate;
            if (currentCurrency === 'INR') {
                return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(convertedAmount);
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: currentCurrency }).format(convertedAmount);
        };

        // --- UI Update Functions ---
        const updateUIForAuth = () => {
            loginLogoutBtn.disabled = !isAuthReady;
            showRegisterBtn.disabled = !isAuthReady;
            googleSignInBtn.disabled = !isAuthReady; // Enable Google Sign-In button too

            if (appUser) {
                loginLogoutBtn.textContent = `Logout (${appUser.username})`;
                if (appUser.isAdmin) {
                    toggleAdminPanelBtn.classList.remove('hidden');
                } else {
                    toggleAdminPanelBtn.classList.add('hidden');
                }
                // Show login history panel if user is logged in
                loginHistoryPanel.classList.remove('hidden');
                renderLoginTimestamps(appUser.loginTimestamps || []);
            } else {
                loginLogoutBtn.textContent = 'Login/Logout';
                toggleAdminPanelBtn.classList.add('hidden');
                loginHistoryPanel.classList.add('hidden'); // Hide on logout
                if (currentView === 'admin') {
                    showSection(storeView);
                    filterAndSortProducts(); // Refresh products on logout
                    currentView = 'store';
                }
            }
            if (isAuthReady) {
                authStatusMessage.textContent = appUser ? `Authenticated as ${appUser.username} (Firebase UID: ${userId})` : 'Ready. Please login or register.';
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-gray-700', 'bg-red-500');
                setTimeout(() => {
                    authStatusMessage.style.display = 'none';
                }, 3000);
            } else {
                authStatusMessage.textContent = 'Initializing authentication...';
                authStatusMessage.classList.remove('bg-green-500', 'bg-red-500');
                authStatusMessage.classList.add('bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        };

        const showSection = (sectionToShow) => {
            storeView.classList.add('hidden');
            cartView.classList.add('hidden');
            adminPanel.classList.add('hidden');
            paymentView.classList.add('hidden');
            sectionToShow.classList.remove('hidden');
        };

        /**
         * Filters and sorts products based on current search query and category filter.
         * Then renders them to the product grid.
         */
        const filterAndSortProducts = () => {
            let filteredProducts = [...products]; // Create a mutable copy

            // 1. Apply Search Filter
            if (currentSearchQuery) {
                const query = currentSearchQuery.toLowerCase();
                filteredProducts = filteredProducts.filter(product =>
                    product.name.toLowerCase().includes(query) ||
                    product.description.toLowerCase().includes(query)
                );
            }

            // 2. Apply Category Filter
            if (currentCategoryFilter !== 'all') {
                if (currentCategoryFilter === 'latest') {
                    filteredProducts.sort((a, b) => (b.createdAt?.toDate()?.getTime() || 0) - (a.createdAt?.toDate()?.getTime() || 0));
                } else if (currentCategoryFilter === 'oldest') {
                    filteredProducts.sort((a, b) => (a.createdAt?.toDate()?.getTime() || 0) - (b.createdAt?.toDate()?.getTime() || 0));
                } else {
                    filteredProducts = filteredProducts.filter(product =>
                        product.category && product.category.toLowerCase() === currentCategoryFilter.toLowerCase()
                    );
                }
            }

            // 3. Apply Brand Filter (NEW)
            if (currentBrandFilter !== 'all') {
                filteredProducts = filteredProducts.filter(product =>
                    product.brand && product.brand.toLowerCase() === currentBrandFilter.toLowerCase()
                );
            }

            // 4. Apply Part Type Filter (NEW)
            if (currentPartTypeFilter !== 'all') {
                filteredProducts = filteredProducts.filter(product =>
                    product.partType && product.partType.toLowerCase() === currentPartTypeFilter.toLowerCase()
                );
            }


            productGrid.innerHTML = '';
            if (filteredProducts.length === 0) {
                noFilteredProductsMessage.classList.remove('hidden');
                productGrid.innerHTML = ''; // Ensure grid is empty
            } else {
                noFilteredProductsMessage.classList.add('hidden');
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 overflow-hidden border border-gray-200';
                    productCard.innerHTML = `
                        <img src="${product.imageUrl || 'https://placehold.co/400x300/F0F0F0/000000?text=No+Image'}" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-semibold text-gray-900 mb-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-4 line-clamp-3">${product.description}</p>
                            ${product.category ? `<p class="text-xs text-gray-500 mb-1">Category: ${product.category}</p>` : ''}
                            ${product.brand ? `<p class="text-xs text-gray-500 mb-1">Brand: ${product.brand}</p>` : ''}
                            ${product.partType ? `<p class="text-xs text-gray-500 mb-2">Part Type: ${product.partType}</p>` : ''}
                            <div class="flex justify-between items-center">
                                <span class="text-2xl font-bold text-blue-600">${formatPriceForDisplay(product.price)}</span>
                                <button data-product-id="${product.id}" class="add-to-cart-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-300">
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    `;
                    productGrid.appendChild(productCard);
                });
            }
        };

        const renderCart = () => {
            cartItemsContainer.innerHTML = '';
            let total = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center text-gray-500 text-lg">Your cart is empty.</p>';
                checkoutBtn.disabled = true;
            } else {
                checkoutBtn.disabled = false;
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        const itemTotal = product.price * item.quantity;
                        total += itemTotal;

                        const cartItemDiv = document.createElement('div');
                        cartItemDiv.className = 'flex items-center space-x-4 p-4 bg-gray-50 rounded-lg shadow-sm';
                        cartItemDiv.innerHTML = `
                            <img src="${product.imageUrl || 'https://placehold.co/100x75?text=Product'}" alt="${product.name}" class="w-24 h-24 object-cover rounded-md">
                            <div class="flex-grow">
                                <h4 class="text-lg font-semibold text-gray-800">${product.name}</h4>
                                <p class="text-gray-600">${formatPriceForDisplay(product.price)} each</p>
                                <div class="flex items-center mt-2">
                                    <button data-id="${item.id}" class="decrease-quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-l-md hover:bg-gray-300 transition duration-150">-</button>
                                    <span class="px-4 py-1 border-t border-b border-gray-200 text-gray-800">${item.quantity}</span>
                                    <button data-id="${item.id}" class="increase-quantity-btn bg-gray-200 text-gray-700 px-3 py-1 rounded-r-md hover:bg-gray-300 transition duration-150">+</button>
                                    <button data-id="${item.id}" class="remove-from-cart-btn ml-4 bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-md transition duration-150">Remove</button>
                                </div>
                            </div>
                            <span class="text-xl font-bold text-gray-900">${formatPriceForDisplay(itemTotal)}</span>
                        `;
                        cartItemsContainer.appendChild(cartItemDiv);
                    }
                });
            }
            cartTotalSpan.textContent = formatPriceForDisplay(total);
            updateCartCount();
        };

        const updateCartCount = () => {
            const count = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartItemCount.textContent = count;
        };

        const renderAdminProducts = () => {
            adminProductList.innerHTML = '';
            if (products.length === 0) {
                noProductsMessage.classList.remove('hidden');
            } else {
                noProductsMessage.classList.add('hidden');
                products.forEach(product => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><img src="${product.imageUrl || 'https://placehold.co/50x50'}" alt="${product.name}" class="w-12 h-12 object-cover rounded"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${product.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatPriceForDisplay(product.price)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.category || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.brand || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${product.partType || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${product.id}" class="edit-product-btn text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                            <button data-id="${product.id}" class="delete-product-btn text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    adminProductList.appendChild(row);
                });
            }
        };

        const renderAdminCategories = () => {
            adminCategoryList.innerHTML = '';
            if (categories.length === 0) {
                noCategoriesMessage.classList.remove('hidden');
            } else {
                noCategoriesMessage.classList.add('hidden');
                categories.forEach(category => {
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${category.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button data-id="${category.id}" class="edit-category-btn text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                            <button data-id="${category.id}" class="delete-category-btn text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    adminCategoryList.appendChild(row);
                });
            }
            // Populate category select dropdowns
            populateCategorySelects();
        };

        // NEW: Populate Brand and Part Type dropdowns
        const populateBrandAndPartTypeSelects = () => {
            brandFilterSelect.innerHTML = '<option value="all">Please Select Brand</option>';
            allBrands.sort().forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandFilterSelect.appendChild(option);

                const adminOption = document.createElement('option');
                adminOption.value = brand;
                adminOption.textContent = brand;
                productBrandSelect.appendChild(adminOption);
            });
            brandFilterSelect.value = currentBrandFilter; // Re-select current filter


            partTypeFilterSelect.innerHTML = '<option value="all">Please Select Part Type</option>';
            allPartTypes.sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                partTypeFilterSelect.appendChild(option);

                const adminOption = document.createElement('option');
                adminOption.value = type;
                adminOption.textContent = type;
                productPartTypeSelect.appendChild(adminOption);
            });
            partTypeFilterSelect.value = currentPartTypeFilter; // Re-select current filter
        };

        // Update existing populate category select function
        const populateCategorySelects = () => {
            productCategorySelect.innerHTML = '<option value="">Select a Category</option>';
            categoryFilterSelect.innerHTML = '<option value="all">Please Select Category</option><option value="latest">Latest Products</option><option value="oldest">Oldest Products</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name;
                productCategorySelect.appendChild(option);

                const filterOption = document.createElement('option');
                filterOption.value = category.name;
                filterOption.textContent = category.name;
                categoryFilterSelect.appendChild(filterOption);
            });
            // Re-select current filter after options are populated
            categoryFilterSelect.value = currentCategoryFilter;
        }

        // NEW: Render login timestamps
        const renderLoginTimestamps = (timestamps) => {
            loginTimestampsList.innerHTML = '';
            if (timestamps && timestamps.length > 0) {
                // Sort in descending order to show most recent first
                const sortedTimestamps = [...timestamps].sort((a, b) => b.toDate().getTime() - a.toDate().getTime());
                sortedTimestamps.slice(0, 15).forEach(ts => {
                    const li = document.createElement('li');
                    li.textContent = `Login at: ${ts.toDate().toLocaleString()}`;
                    loginTimestampsList.appendChild(li);
                });
            } else {
                loginTimestampsList.innerHTML = '<li>No previous login records.</li>';
            }
        };


        // --- Firebase Firestore Operations ---

        // Fetch products with real-time updates
        const setupProductsListener = () => {
            const q = query(collection(db, "products"));
            onSnapshot(q, (snapshot) => {
                products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                filterAndSortProducts();
                if (currentView === 'admin') {
                    renderAdminProducts();
                }
                renderCart(); // Update cart display in case product info changed
            }, (error) => {
                console.error("Error fetching products:", error);
                authStatusMessage.textContent = 'Error fetching products. Check console.';
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            });
        };

        // Fetch categories with real-time updates
        const setupCategoriesListener = () => {
            const q = query(collection(db, "categories"));
            onSnapshot(q, (snapshot) => {
                categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderAdminCategories(); // Re-render admin categories and update select dropdowns
                filterAndSortProducts(); // Re-filter products if categories changed
            }, (error) => {
                console.error("Error fetching categories:", error);
                authStatusMessage.textContent = 'Error fetching categories. Check console.';
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            });
        };


        const getProducts = async () => {
            try {
                const productsCol = collection(db, 'products');
                const productSnapshot = await getDocs(productsCol);
                if (productSnapshot.empty) {
                    // Populate initial products if collection is empty
                    for (const product of initialProductsData) {
                        await addDoc(productsCol, product);
                    }
                    console.log("Initial products populated.");
                }
            } catch (e) {
                console.error("Error getting or populating products:", e);
            }
        };

        const getCategories = async () => {
            try {
                const categoriesCol = collection(db, 'categories');
                const categorySnapshot = await getDocs(categoriesCol);
                if (categorySnapshot.empty) {
                    // Populate initial categories if collection is empty
                    for (const category of initialCategoriesData) {
                        await addDoc(categoriesCol, category);
                    }
                    console.log("Initial categories populated.");
                }
            } catch (e) {
                console.error("Error getting or populating categories:", e);
            }
        };

        const addUpdateProduct = async (productData) => {
            try {
                if (productData.id) {
                    // Update existing product
                    const productRef = doc(db, 'products', productData.id);
                    await setDoc(productRef, productData, { merge: true });
                    console.log("Product updated:", productData.id);
                    authStatusMessage.textContent = 'Product updated successfully!';
                } else {
                    // Add new product
                    // Use addDoc for auto-ID, or setDoc with generateUniqueId() for custom ID
                    await addDoc(collection(db, 'products'), { ...productData, createdAt: Timestamp.now() });
                    console.log("Product added:", productData.name);
                    authStatusMessage.textContent = 'Product added successfully!';
                }
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
                resetProductForm();
            } catch (e) {
                console.error("Error adding/updating product:", e);
                authStatusMessage.textContent = `Error: ${e.message}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        };

        const deleteProduct = async (id) => {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'products', id));
                console.log("Product deleted:", id);
                authStatusMessage.textContent = 'Product deleted successfully!';
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
            } catch (e) {
                console.error("Error deleting product:", e);
                authStatusMessage.textContent = `Error: ${e.message}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        };

        const addUpdateCategory = async (categoryData) => {
            try {
                if (categoryData.id) {
                    // Update existing category
                    const categoryRef = doc(db, 'categories', categoryData.id);
                    await setDoc(categoryRef, categoryData, { merge: true });
                    console.log("Category updated:", categoryData.id);
                    authStatusMessage.textContent = 'Category updated successfully!';
                } else {
                    // Add new category
                    await addDoc(collection(db, 'categories'), categoryData);
                    console.log("Category added:", categoryData.name);
                    authStatusMessage.textContent = 'Category added successfully!';
                }
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
                resetCategoryForm();
            } catch (e) {
                console.error("Error adding/updating category:", e);
                authStatusMessage.textContent = `Error: ${e.message}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        };

        const deleteCategory = async (id) => {
            if (!confirm('Are you sure you want to delete this category? This will not delete products associated with it.')) {
                return;
            }
            try {
                await deleteDoc(doc(db, 'categories', id));
                console.log("Category deleted:", id);
                authStatusMessage.textContent = 'Category deleted successfully!';
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
            } catch (e) {
                console.error("Error deleting category:", e);
                authStatusMessage.textContent = `Error: ${e.message}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        };

        const getUserData = async (uid) => {
            try {
                const userDocRef = doc(db, 'users', uid);
                const userDocSnap = await getDoc(userDocRef);
                if (userDocSnap.exists()) {
                    return userDocSnap.data();
                }
                return null;
            } catch (error) {
                console.error("Error getting user data:", error);
                return null;
            }
        };

        const setUserData = async (uid, data) => {
            try {
                const userDocRef = doc(db, 'users', uid);
                await setDoc(userDocRef, data, { merge: true });
                console.log("User data set for", uid);
            } catch (error) {
                console.error("Error setting user data:", error);
            }
        };

        // NEW: Function to add login timestamp to user document
        const addLoginTimestamp = async (uid) => {
            try {
                const userRef = doc(db, 'users', uid);
                const userDoc = await getDoc(userRef);
                let currentTimestamps = [];
                if (userDoc.exists() && userDoc.data().loginTimestamps) {
                    currentTimestamps = userDoc.data().loginTimestamps;
                }

                // Add new timestamp, keep only the last 15
                const newTimestamp = Timestamp.now();
                currentTimestamps.push(newTimestamp);
                if (currentTimestamps.length > 15) {
                    currentTimestamps = currentTimestamps.slice(-15); // Keep last 15
                }

                await updateDoc(userRef, {
                    loginTimestamps: currentTimestamps
                });
                console.log("Login timestamp added for user:", uid);
                // Update appUser with the latest timestamps
                if (appUser && appUser.uid === uid) {
                    appUser.loginTimestamps = currentTimestamps;
                    renderLoginTimestamps(appUser.loginTimestamps);
                }

            } catch (error) {
                console.error("Error adding login timestamp:", error);
            }
        };


        // --- Event Handlers ---

        homeLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection(storeView);
            currentView = 'store';
            currentSearchQuery = ''; // Clear search on home
            productSearchInput.value = '';
            currentCategoryFilter = 'all'; // Reset category filter
            categoryFilterSelect.value = 'all';
            currentBrandFilter = 'all'; // Reset brand filter
            brandFilterSelect.value = 'all';
            currentPartTypeFilter = 'all'; // Reset part type filter
            partTypeFilterSelect.value = 'all';
            filterAndSortProducts();
        });

        viewCartBtn.addEventListener('click', () => {
            showSection(cartView);
            currentView = 'cart';
            renderCart();
        });

        toggleAdminPanelBtn.addEventListener('click', () => {
            if (appUser && appUser.isAdmin) {
                showSection(adminPanel);
                currentView = 'admin';
                renderAdminProducts();
                renderAdminCategories(); // Ensure categories are rendered for management
                populateBrandAndPartTypeSelects(); // Ensure brand/part type dropdowns are populated
            } else {
                alert('You must be an administrator to access this panel.');
                showSection(storeView); // Redirect to store if not admin
                currentView = 'store';
            }
        });

        loginLogoutBtn.addEventListener('click', async () => {
            if (appUser) {
                // Logout logic
                try {
                    await signOut(auth);
                    appUser = null;
                    userId = null;
                    console.log('User logged out.');
                    authStatusMessage.textContent = 'Logged out successfully.';
                    authStatusMessage.classList.add('bg-green-500');
                    authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                    authStatusMessage.style.display = 'block';
                    setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
                    updateUIForAuth();
                    showSection(storeView); // Go to store view on logout
                    currentView = 'store';
                } catch (error) {
                    console.error("Error logging out:", error);
                    authStatusMessage.textContent = `Error logging out: ${error.message}`;
                    authStatusMessage.classList.add('bg-red-500');
                    authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                    authStatusMessage.style.display = 'block';
                }
            } else {
                // Show login modal
                loginModal.classList.add('open');
            }
        });

        closeLoginModalBtn.addEventListener('click', () => {
            loginModal.classList.remove('open');
            loginForm.reset();
        });

        showRegisterBtn.addEventListener('click', () => {
            loginModal.classList.remove('open');
            registerModal.classList.add('open');
        });

        cancelRegisterBtn.addEventListener('click', () => {
            registerModal.classList.remove('open');
            registerForm.reset();
            loginModal.classList.add('open'); // Go back to login modal
        });

        closeRegisterModalBtn.addEventListener('click', () => {
            registerModal.classList.remove('open');
            registerForm.reset();
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = usernameLoginInput.value.trim();
            const password = passwordLoginInput.value.trim();

            // --- LOCAL ADMIN BYPASS (kundan/kundan) ---
            if (email === 'kundan' && password === 'kundan') {
                appUser = {
                    username: 'kundan (Local Admin)',
                    email: 'kundan',
                    isAdmin: true,
                    uid: 'local_kundan_admin', // A unique ID for the local session
                    loginTimestamps: [Timestamp.now()] // Simulate a timestamp for local admin
                };
                userId = 'local_kundan_admin';
                console.log("Logged in as local admin (kundan/kundan). This is a client-side only bypass.");
                loginModal.classList.remove('open');
                loginForm.reset();
                updateUIForAuth();
                showSection(adminPanel); // Automatically go to admin panel
                currentView = 'admin';
                renderAdminProducts();
                renderAdminCategories();
                populateBrandAndPartTypeSelects();
                return; // Stop further processing
            }
            // --- END LOCAL ADMIN BYPASS ---

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // After successful Firebase login, get user data and update timestamp
                await addLoginTimestamp(user.uid); // Add current login timestamp
                const userData = await getUserData(user.uid); // Re-fetch user data to get updated timestamps
                appUser = {
                    username: userData?.username || user.email,
                    email: user.email,
                    isAdmin: userData?.isAdmin || false,
                    uid: user.uid,
                    loginTimestamps: userData?.loginTimestamps || []
                };
                userId = user.uid;

                console.log("User logged in:", user.email);
                loginModal.classList.remove('open');
                loginForm.reset();
                updateUIForAuth();
                authStatusMessage.textContent = `Logged in as ${appUser.username}.`;
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
            } catch (error) {
                console.error("Login failed:", error);
                let errorMessage = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email format.";
                }
                authStatusMessage.textContent = `Error: ${errorMessage}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        });

        googleSignInBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user; // The signed-in user info.

                // Check if user exists in Firestore 'users' collection
                const userDocSnap = await getDoc(doc(db, 'users', user.uid));
                if (!userDocSnap.exists()) {
                    // Create new user document if they don't exist
                    await setDoc(doc(db, 'users', user.uid), {
                        username: user.displayName || user.email,
                        email: user.email,
                        isAdmin: false, // Default to non-admin for new Google sign-ins
                        createdAt: Timestamp.now(),
                        loginTimestamps: []
                    });
                    console.log("New user registered via Google:", user.email);
                }

                // After successful Firebase login, get user data and update timestamp
                await addLoginTimestamp(user.uid); // Add current login timestamp
                const userData = await getUserData(user.uid); // Re-fetch user data to get updated timestamps
                appUser = {
                    username: userData?.username || user.displayName || user.email,
                    email: user.email,
                    isAdmin: userData?.isAdmin || false,
                    uid: user.uid,
                    loginTimestamps: userData?.loginTimestamps || []
                };
                userId = user.uid;

                console.log("User logged in via Google:", user.email);
                loginModal.classList.remove('open');
                loginForm.reset();
                updateUIForAuth();
                authStatusMessage.textContent = `Logged in as ${appUser.username} via Google.`;
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);

            } catch (error) {
                console.error("Google Sign-In failed:", error);
                let errorMessage = "Google Sign-In failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Google Sign-In popup closed.";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "Sign-in cancelled.";
                }
                authStatusMessage.textContent = `Error: ${errorMessage}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        });


        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = usernameRegisterInput.value.trim();
            const email = emailRegisterInput.value.trim();
            const password = passwordRegisterInput.value.trim();
            const confirmPassword = confirmPasswordRegisterInput.value.trim();

            if (password !== confirmPassword) {
                alert("Passwords do not match!");
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // Store additional user data in Firestore
                await setUserData(user.uid, {
                    username: username,
                    email: email,
                    isAdmin: false, // New users are not admins by default
                    createdAt: Timestamp.now(),
                    loginTimestamps: [Timestamp.now()] // Record first login timestamp
                });

                appUser = {
                    username: username,
                    email: email,
                    isAdmin: false,
                    uid: user.uid,
                    loginTimestamps: [Timestamp.now()]
                };
                userId = user.uid;

                console.log("User registered:", user.email);
                registerModal.classList.remove('open');
                registerForm.reset();
                updateUIForAuth();
                authStatusMessage.textContent = `Registered and logged in as ${appUser.username}.`;
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 3000);
            } catch (error) {
                console.error("Registration failed:", error);
                let errorMessage = "Registration failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "Email already in use. Please use a different email or login.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak (min 6 characters).";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Invalid email address.";
                }
                authStatusMessage.textContent = `Error: ${errorMessage}`;
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-green-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
            }
        });


        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = productIdInput.value;
            const name = productNameInput.value.trim();
            const description = productDescriptionInput.value.trim();
            const price = parseFloat(productPriceInput.value);
            const imageUrl = productImageUrlInput.value.trim();
            const category = productCategorySelect.value;
            const brand = productBrandSelect.value; // NEW
            const partType = productPartTypeSelect.value; // NEW

            if (!name || !description || isNaN(price) || price <= 0 || !category || !brand || !partType) {
                alert('Please fill in all required product fields (Name, Description, Price, Category, Brand, Part Type) and ensure price is valid.');
                return;
            }

            const productData = { name, description, price, imageUrl, category, brand, partType }; // Include new fields
            if (id) {
                productData.id = id;
            }
            await addUpdateProduct(productData);
        });

        cancelEditBtn.addEventListener('click', resetProductForm);

        function resetProductForm() {
            productForm.reset();
            productIdInput.value = '';
            formTitle.textContent = 'Add New Product';
            submitBtnText.textContent = 'Add Product';
            cancelEditBtn.classList.add('hidden');
        }

        adminProductList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-product-btn')) {
                const id = e.target.dataset.id;
                const productToEdit = products.find(p => p.id === id);
                if (productToEdit) {
                    productIdInput.value = productToEdit.id;
                    productNameInput.value = productToEdit.name;
                    productDescriptionInput.value = productToEdit.description;
                    productPriceInput.value = productToEdit.price;
                    productImageUrlInput.value = productToEdit.imageUrl;
                    productCategorySelect.value = productToEdit.category || '';
                    productBrandSelect.value = productToEdit.brand || ''; // NEW
                    productPartTypeSelect.value = productToEdit.partType || ''; // NEW

                    formTitle.textContent = 'Edit Product';
                    submitBtnText.textContent = 'Update Product';
                    cancelEditBtn.classList.remove('hidden');
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to form
                }
            } else if (e.target.classList.contains('delete-product-btn')) {
                const id = e.target.dataset.id;
                await deleteProduct(id);
            }
        });


        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = categoryIdInput.value;
            const name = categoryNameInput.value.trim();

            if (!name) {
                alert('Please enter a category name.');
                return;
            }

            const categoryData = { name };
            if (id) {
                categoryData.id = id;
            }
            await addUpdateCategory(categoryData);
        });

        cancelCategoryEditBtn.addEventListener('click', resetCategoryForm);

        function resetCategoryForm() {
            categoryForm.reset();
            categoryIdInput.value = '';
            submitCategoryBtnText.textContent = 'Add Category';
            cancelCategoryEditBtn.classList.add('hidden');
        }

        adminCategoryList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('edit-category-btn')) {
                const id = e.target.dataset.id;
                const categoryToEdit = categories.find(c => c.id === id);
                if (categoryToEdit) {
                    categoryIdInput.value = categoryToEdit.id;
                    categoryNameInput.value = categoryToEdit.name;

                    submitCategoryBtnText.textContent = 'Update Category';
                    cancelCategoryEditBtn.classList.remove('hidden');
                }
            } else if (e.target.classList.contains('delete-category-btn')) {
                const id = e.target.dataset.id;
                await deleteCategory(id);
            }
        });


        productGrid.addEventListener('click', (e) => {
            if (e.target.classList.contains('add-to-cart-btn')) {
                const productId = e.target.dataset.productId;
                const existingItem = cart.find(item => item.id === productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    cart.push({ id: productId, quantity: 1 });
                }
                saveCart();
                authStatusMessage.textContent = 'Item added to cart!';
                authStatusMessage.classList.add('bg-green-500');
                authStatusMessage.classList.remove('bg-red-500', 'bg-gray-700');
                authStatusMessage.style.display = 'block';
                setTimeout(() => { authStatusMessage.style.display = 'none'; }, 2000);
            }
        });

        cartItemsContainer.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            const itemIndex = cart.findIndex(item => item.id === id);

            if (itemIndex > -1) {
                if (e.target.classList.contains('increase-quantity-btn')) {
                    cart[itemIndex].quantity++;
                } else if (e.target.classList.contains('decrease-quantity-btn')) {
                    if (cart[itemIndex].quantity > 1) {
                        cart[itemIndex].quantity--;
                    }
                } else if (e.target.classList.contains('remove-from-cart-btn')) {
                    cart.splice(itemIndex, 1);
                }
                saveCart();
                renderCart();
            }
        });

        checkoutBtn.addEventListener('click', () => {
            cart = []; // Clear cart on checkout
            saveCart();
            showSection(paymentView);
            currentView = 'payment';
            updateCartCount();
        });

        returnToStoreBtn.addEventListener('click', () => {
            showSection(storeView);
            currentView = 'store';
            filterAndSortProducts();
        });

        currencySelect.addEventListener('change', (e) => {
            currentCurrency = e.target.value;
            saveCurrency();
            filterAndSortProducts(); // Re-render products to update prices
            if (currentView === 'cart') {
                renderCart(); // Re-render cart to update prices
            }
            if (currentView === 'admin') {
                 renderAdminProducts(); // Re-render admin product list to update prices
            }
        });

        productSearchInput.addEventListener('input', (e) => {
            currentSearchQuery = e.target.value;
            filterAndSortProducts();
        });

        categoryFilterSelect.addEventListener('change', (e) => {
            currentCategoryFilter = e.target.value;
            filterAndSortProducts();
        });

        brandFilterSelect.addEventListener('change', (e) => { // NEW
            currentBrandFilter = e.target.value;
            filterAndSortProducts();
        });

        partTypeFilterSelect.addEventListener('change', (e) => { // NEW
            currentPartTypeFilter = e.target.value;
            filterAndSortProducts();
        });


        // --- Firebase Auth State Listener ---
        const initializeAppAndFirebase = async () => {
            try {
                // Initialize Firebase app only once
                if (!app) {
                    app = initializeApp(firebaseConfig, appId);
                    db = getFirestore(app);
                    auth = getAuth(app);
                }

                // Check if running in a Google Canvas environment for authentication
                if (typeof __is_running_in_google_canvas !== 'undefined' && __is_running_in_google_canvas) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        console.log("Signed in with custom token from Canvas.");
                    } else {
                        try {
                            await signInAnonymously(auth);
                            console.log("Signed in anonymously in Canvas environment.");
                        } catch (error) {
                            console.error("Error signing in anonymously:", error);
                        }
                    }
                }

                // Listen for authentication state changes
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // Fetch user's custom data from Firestore
                        const userData = await getUserData(user.uid);
                        appUser = {
                            username: userData?.username || user.email,
                            email: user.email,
                            isAdmin: userData?.isAdmin || false,
                            uid: user.uid,
                            loginTimestamps: userData?.loginTimestamps || [] // Get timestamps
                        };
                        console.log("Firebase Auth State Changed: Logged in as", appUser.username);
                        // Add current login timestamp only if it's a real Firebase user (not local kundan admin)
                        if (user.uid !== 'local_kundan_admin') {
                             await addLoginTimestamp(user.uid);
                        }

                    } else {
                        appUser = null;
                        userId = null;
                        console.log("Firebase Auth State Changed: Logged out or no user.");
                    }
                    isAuthReady = true;
                    updateUIForAuth();
                    setupProductsListener(); // Listen for product updates
                    setupCategoriesListener(); // Listen for category updates
                    // Initial fetch (if listeners don't immediately trigger)
                    getProducts();
                    getCategories();
                    populateBrandAndPartTypeSelects(); // Populate dropdowns on init
                });

                loadCart();
                loadCurrency();
                updateCartCount();
                updateUIForAuth(); // Initial UI update

            } catch (error) {
                console.error("Failed to initialize Firebase or application:", error);
                authStatusMessage.textContent = 'Error: Firebase failed to initialize. Check console.';
                authStatusMessage.classList.add('bg-red-500');
                authStatusMessage.classList.remove('bg-gray-700');
                loginLogoutBtn.disabled = true;
                showRegisterBtn.disabled = true;
                googleSignInBtn.disabled = true; // Disable Google Sign-In on init error
            }
        };

        document.addEventListener('DOMContentLoaded', initializeAppAndFirebase);

    </script>

<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    updateDoc,
    Timestamp
  } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBFKQa1_X2K3fSp1o0Co5uy9neWK9GGceQ",
    authDomain: "mobile-doctor-app.firebaseapp.com",
    projectId: "mobile-doctor-app",
    storageBucket: "mobile-doctor-app.appspot.com",
    messagingSenderId: "831443700901",
    appId: "1:831443700901:web:5848c1e848e4503b28514c"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const registerForm = document.getElementById('registerForm');
  const loginForm = document.getElementById('loginForm');
  const loginModal = document.getElementById('loginModal');
  const registerModal = document.getElementById('registerModal');

  // Register Logic
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = document.getElementById('usernameRegister').value.trim();
    const email = document.getElementById('emailRegister').value.trim();
    const password = document.getElementById('passwordRegister').value.trim();
    const confirmPassword = document.getElementById('confirmPasswordRegister').value.trim();

    if (password !== confirmPassword) {
      alert("Passwords do not match!");
      return;
    }

    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, password);
      const uid = userCred.user.uid;

      await setDoc(doc(db, 'users', uid), {
        username,
        email,
        isAdmin: false,
        loginTimestamps: [Timestamp.now()]
      });

      alert("Registered successfully!");
      registerModal.classList.remove('open');
      registerForm.reset();
    } catch (error) {
      alert("Registration error: " + error.message);
    }
  });

  // Login Logic
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('usernameLogin').value.trim();
    const password = document.getElementById('passwordLogin').value.trim();

    if (email === 'kundan' && password === 'kundan') {
      alert('Logged in as admin');
      loginModal.classList.remove('open');
      return;
    }

    try {
      const userCred = await signInWithEmailAndPassword(auth, email, password);
      const uid = userCred.user.uid;

      const userDoc = await getDoc(doc(db, 'users', uid));
      if (userDoc.exists()) {
        const userData = userDoc.data();
        await updateDoc(doc(db, 'users', uid), {
          loginTimestamps: [...(userData.loginTimestamps || []), Timestamp.now()]
        });
        alert("Login successful!");
        loginModal.classList.remove('open');
        loginForm.reset();
      }
    } catch (error) {
      alert("Login error: " + error.message);
    }
  });

  // Enable Register Button
  document.getElementById('showRegisterBtn').disabled = false;

  // Password Strength Checker
  document.getElementById('passwordRegister').addEventListener('input', (e) => {
    const val = e.target.value;
    let strength = "Weak";
    if (val.length >= 8 && /[A-Z]/.test(val) && /\d/.test(val)) strength = "Strong";
    else if (val.length >= 6) strength = "Moderate";
    document.getElementById('passwordStrength')?.remove();
    const msg = document.createElement('small');
    msg.id = 'passwordStrength';
    msg.className = 'text-sm text-gray-500';
    msg.textContent = "Password strength: " + strength;
    e.target.parentNode.appendChild(msg);
  });

</script>

</body>
</html>